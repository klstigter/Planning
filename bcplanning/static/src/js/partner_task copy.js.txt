/** @odoo-module **/
import { rpc } from "@web/core/network/rpc";
import publicWidget from "@web/legacy/js/public/public_widget";

publicWidget.registry.ResourceTable = publicWidget.Widget.extend({
    selector: "#task_wrap",

    events: {
        'click .remove-resource-row': '_onRemoveResourceRow',
        'click .add-resource-row': '_onAddResourceRow',
        'change .resource-select': '_onResourceChanged',
        'change .start-datetime-input': '_onStartDatetimeChanged',
        'change .end-datetime-input': '_onEndDatetimeChanged',
    },

    _onRemoveResourceRow: function(ev) {
        ev.preventDefault();
        const $btn = $(ev.currentTarget);
        var planninglineId = $btn.closest('td').data('planninglineId'); // camelCase access

        if (!planninglineId) {
            alert("Planning line id not found!");
            return;
        }

        // Confirmation dialog
        if (!confirm("Do you want to remove this planning line?")) {
            return; // User cancelled
        }
 
        const $tr = $btn.closest('tr');

        rpc('/bcplanningline/delete', { planningline_id: planninglineId }).then(() => {
            $tr.fadeOut(200, function() { 
                // Remove the table row from the DOM
                $tr.remove();
            });
        });
    },

    _onAddResourceRow: function(ev) {
        ev.preventDefault();
        const $btn = $(ev.currentTarget);
        // Find the closest parent table with the attribute
        const $planningTable = $btn.closest('td')// .find('table[data-task-id]').first();
        let taskId = $planningTable.data('taskId');
        
        // If not found, go up from the button in case the button is not inside <td>
        if (!taskId) {
            alert("Task ID not found!");
            return;
        }

        rpc('/bcplanningline/add', { task_id: taskId }).then((result) => {
            // console.log(result);
            // console.log(result.result.resource_options);
            const $newRow = $(`
                <tr>
                <td>
                    <span class="data_planningline_id" style="display:none">${result.result.planningline_id}</span>
                    <select class="resource-select">
                        <option value=""> - </option>
                        ${result.result.resource_options}
                    </select>
                </td>
                <td style="padding-left: 32px;">
                    <button type="button" class="btn btn-sm btn-secondary remove-resource-row">
                    Remove
                    </button>
                </td>
                </tr>
            `);
            $planningTable.find('tbody').append($newRow);
        });
    },
    
    _onResourceChanged: function(ev) {
        const $select = $(ev.currentTarget);
        const $td = $select.closest('td'); // Get current td
        const planninglineId = $td.find('.data_planningline_id').text().trim();
        const resourceId = $select.val();

        // Store previous value before change (using data attribute, or closure variable)
        const previousValue = $select.data('previous-value') || $select.find('option[selected]').val();
        // console.log(previousValue);

        if (!planninglineId) return;

        rpc('/bcplanningline/update', {
            planningline_id: planninglineId,
            resource_id: resourceId
        }).then(function(result) {
            if (result.result && result.result === 'updated') {
                alert('Resource updated successfully');
                // Optionally update previousValue
                $select.data('previous-value', resourceId);
            } else {
                alert(result.result || 'Unknown result');
                // Restore previous selection
                $select.val(previousValue);
            }
        });
    },

    _onStartDatetimeChanged: function(ev) {
        console.log('start datetime changed', ev); // <-- Add this line!
        const $input = $(ev.currentTarget);
        const $tr = $input.closest('tr');
        const planninglineId = $tr.find('.data_planningline_id').text().trim();
        const newValue = $input.val();

        if (!planninglineId) return;

        rpc('/bcplanningline/update_datetime', {
            planningline_id: planninglineId,
            start_datetime: newValue,
            end_datetime: null,
        }).then(function(result) {
            if (result.result !== 'updated') {
                // Only show alert once
                if (result.old_start_datetime !== undefined) {
                    $input.val(result.old_start_datetime);
                }
                alert(result.result || 'Update failed');
            }
        });
    },

    _onEndDatetimeChanged: function(ev) {
        console.log('end datetime changed', ev); // <-- Add this line!
        const $input = $(ev.currentTarget);
        const $tr = $input.closest('tr');
        const planninglineId = $tr.find('.data_planningline_id').text().trim();
        const newValue = $input.val();

        if (!planninglineId) return;

        rpc('/bcplanningline/update_datetime', {
            planningline_id: planninglineId,
            start_datetime: null,
            end_datetime: newValue,
        }).then(function(result) {
            if (result.result !== 'updated') {
                // Only show alert once
                if (result.old_end_datetime !== undefined) {
                    $input.val(result.old_end_datetime);
                }
                alert(result.result || 'Update failed');
            }
        });
    },

    start: function () {
        this.$('tr').each(function() {
            const $tr = $(this);
            const planninglineId = $tr.find('select.resource-select').data('planningline-id');
            if (planninglineId) {
                $tr.attr('data-planningline-id', planninglineId);
            }
            const taskId = $tr.find('td').first().data('task-id');
            if (taskId) {
                $tr.attr('data-task-id', taskId);
            }
        });
        return this._super.apply(this, arguments);
    },
});