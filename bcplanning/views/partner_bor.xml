<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <template id="web_partner_bor_template">
    <t t-call="website.layout">
      <div id="bor_wrap" class="oe_structure">
        <div class="container py-4">

          <!-- Project context / breadcrumb -->
          <div class="row mb-2">
            <div class="col-12 col-md-10 mx-auto">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                  <li class="breadcrumb-item"><a t-att-href="'/partner/projects'">Projects</a></li>
                  <t t-if="job_id">
                    <li class="breadcrumb-item active" aria-current="page">
                      <span class="fw-bold"><t t-esc="job_no or job_id"/></span>
                      <t t-if="job_desc and job_desc != ''">
                        <span class="text-muted"> â€” <t t-esc="job_desc"/></span>
                      </t>
                    </li>
                  </t>
                  <t t-if="not job_id">
                    <li class="breadcrumb-item active" aria-current="page">
                      <span class="text-muted">All projects</span>
                    </li>
                  </t>
                </ol>
              </nav>
            </div>
          </div>

          <!-- toolbar: date navigation -->
          <div class="row mb-3">
            <div class="col-12 col-md-10 mx-auto text-center">
              <div class="btn-toolbar justify-content-center" role="toolbar" aria-label="Date toolbar">
                <div class="btn-group me-2" role="group" aria-label="Prev Today Next">
                  <button id="btn-prev-day" type="button" class="btn btn-outline-primary btn-sm">&lt;&lt;</button>
                  <button id="btn-today" type="button" class="btn btn-outline-secondary btn-sm">Selected Date</button>
                  <button id="btn-next-day" type="button" class="btn btn-outline-primary btn-sm">&gt;&gt;</button>
                </div>
                <div class="btn-group me-2" role="group" aria-label="Clear filter">
                  <button id="btn-clear" type="button" class="btn btn-outline-danger btn-sm">Clear Date Filter</button>
                </div>
                <div class="btn-group" role="group" aria-label="Date label">
                  <span id="selected-date-label" class="btn btn-light btn-sm ms-2" t-esc="selected_date or 'All dates'"> </span>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12 col-md-10 mx-auto">
              <div class="card border-0 shadow-sm">
                <div class="card-body">

                  <!-- DESKTOP / TABLE VIEW (visible on md and larger) -->
                  <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover align-middle">
                      <thead class="table-light">
                        <tr>
                          <th class="text-primary fw-bold fs-6">Task</th>
                          <th class="text-primary fw-bold fs-6" colspan="6">Planning Lines</th>
                        </tr>
                        <tr>
                          <th>Description</th>
                          <th>Start</th>
                          <th class="d-none d-sm-table-cell">End</th>
                          <th class="d-none d-sm-table-cell">Item</th>
                          <th class="d-none d-sm-table-cell">Qty</th>
                          <th class="d-none d-sm-table-cell">Depth</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        <t t-if="tasks">
                          <t t-foreach="tasks" t-as="task">
                            <t t-set="row_counter" t-value="0"/>
                            <t t-if="task['planninglines']">
                              <t t-foreach="task['planninglines']" t-as="pl">
                                <t t-set="pl_count" t-value="len(task.get('planninglines') or [])"/>
                                <t t-set="row_counter" t-value="row_counter + 1"/>

                                <!-- Description row: read-only text above times -->
                                <t t-if="row_counter == 1">
                                  <tr class="pl-desc-row" t-att-data-task-id="task['id']">
                                    <td t-att-rowspan="(pl_count*2) if pl_count else 2" class="align-top">
                                      <table>
                                        <tr><td><span class="text-muted">No.</span></td><td>:</td><td><span class="fw-bold ms-1" t-esc="task['task_no']"/></td></tr>
                                        <tr><td><span class="text-muted">Prj</span></td><td>:</td><td><span class="ms-1" t-esc="task['job_no']"/></td></tr>
                                        <tr><td><span class="text-muted">Desc</span></td><td>:</td><td><span class="ms-1" t-esc="task['task_desc']"/></td></tr>
                                        <tr><td><span class="text-muted">Date</span></td><td>:</td><td><span class="ms-1"><t t-esc="task.get('earliest_start') and task.get('earliest_start').strftime('%Y-%m-%d') or '-'"/></span></td></tr>
                                      </table>
                                    </td>
                                    <td colspan="6" class="p-2">
                                      <div class="pl-desc-view text-wrap small text-muted">
                                        <t t-esc="pl.get('pl_desc') or ''"/>
                                      </div>
                                    </td>
                                  </tr>

                                  <!-- Times row (time-only editor) -->
                                  <tr class="planningline-row" data-editing="0" t-att-data-task-id="task['id']">
                                    <td>
                                      <span class="data_planningline_id d-none"><t t-esc="pl['id']"/></span>

                                      <span class="start-datetime-view"
                                            t-att-data-start-date="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%Y-%m-%d') or ''"
                                            t-att-data-start-datetime="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%Y-%m-%dT%H:%M:%S') or ''">
                                        <t t-esc="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%H:%M') or ''"/>
                                      </span>
                                      <input type="time" class="start-datetime-input form-control form-control-sm d-none"
                                             t-att-value="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%H:%M') or ''"/>
                                    </td>

                                    <td class="d-none d-sm-table-cell">
                                      <span class="end-datetime-view"
                                            t-att-data-end-date="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%Y-%m-%d') or ''"
                                            t-att-data-end-datetime="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%Y-%m-%dT%H:%M:%S') or ''">
                                        <t t-esc="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%H:%M') or ''"/>
                                      </span>
                                      <input type="time" class="end-datetime-input form-control form-control-sm d-none"
                                             t-att-value="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%H:%M') or ''"/>
                                    </td>

                                    <!-- Item column: view + select (options from products) -->
                                    <td class="d-none d-sm-table-cell">
                                      <span class="product-view">
                                        <t t-esc="dict((r['id'], r['name']) for r in products).get(pl.get('pl_product_id'), '-')"/>
                                      </span>
                                      <select class="product-select form-select form-select-sm d-none">
                                        <option value=""> - </option>
                                        <t t-foreach="products" t-as="product">
                                          <option t-att-value="product['id']"
                                                  t-att-selected="product['id'] == (pl.get('pl_product_id') or False) and 'selected' or False">
                                            <t t-esc="product['name']"/>
                                          </option>
                                        </t>
                                      </select>
                                    </td>

                                    <!-- Qty column: view + input -->
                                    <td class="d-none d-sm-table-cell">
                                      <span class="qty-view">
                                        <t t-esc="pl.get('pl_qty') if pl.get('pl_qty') is not None else '-'"/>
                                      </span>
                                      <input type="number" min="0" step="1" class="qty-input form-control form-control-sm d-none"
                                             t-att-value="pl.get('pl_qty') if pl.get('pl_qty') is not None else ''"/>
                                    </td>

                                    <!-- Depth column: view + input -->
                                    <td class="d-none d-sm-table-cell">
                                      <span class="depth-view">
                                        <t t-esc="pl.get('pl_depth') if pl.get('pl_depth') is not None else '-'"/>
                                      </span>
                                      <input type="number" min="0" step="0.01" class="depth-input form-control form-control-sm d-none"
                                             t-att-value="pl.get('pl_depth') if pl.get('pl_depth') is not None else ''"/>
                                    </td>

                                    <td>
                                      <button type="button" class="btn btn-sm btn-outline-primary edit-row">Edit</button>
                                      <button type="button" class="btn btn-sm btn-success save-row d-none">Save</button>
                                      <button type="button" class="btn btn-sm btn-secondary cancel-row d-none">Cancel</button>
                                    </td>
                                  </tr>
                                </t>

                                <t t-if="row_counter &gt;= 2">
                                  <tr class="pl-desc-row" t-att-data-task-id="task['id']">
                                    <td colspan="6" class="p-2">
                                      <div class="pl-desc-view text-wrap small text-muted">
                                        <t t-esc="pl.get('pl_desc') or ''"/>
                                      </div>
                                    </td>
                                  </tr>
                                  <tr class="planningline-row" data-editing="0" t-att-data-task-id="task['id']">
                                    <td>
                                      <span class="data_planningline_id d-none"><t t-esc="pl['id']"/></span>

                                      <span class="start-datetime-view"
                                            t-att-data-start-date="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%Y-%m-%d') or ''"
                                            t-att-data-start-datetime="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%Y-%m-%dT%H:%M:%S') or ''">
                                        <t t-esc="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%H:%M') or ''"/>
                                      </span>
                                      <input type="time" class="start-datetime-input form-control form-control-sm d-none"
                                             t-att-value="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%H:%M') or ''"/>
                                    </td>

                                    <td class="d-none d-sm-table-cell">
                                      <span class="end-datetime-view"
                                            t-att-data-end-date="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%Y-%m-%d') or ''"
                                            t-att-data-end-datetime="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%Y-%m-%dT%H:%M:%S') or ''">
                                        <t t-esc="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%H:%M') or ''"/>
                                      </span>
                                      <input type="time" class="end-datetime-input form-control form-control-sm d-none"
                                             t-att-value="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%H:%M') or ''"/>
                                    </td>

                                    <td class="d-none d-sm-table-cell">
                                      <span class="product-view">
                                        <t t-esc="dict((r['id'], r['name']) for r in products).get(pl.get('pl_product_id'), '-')"/>
                                      </span>
                                      <select class="product-select form-select form-select-sm d-none">
                                        <option value=""> - </option>
                                        <t t-foreach="products" t-as="product">
                                          <option t-att-value="product['id']"
                                                  t-att-selected="product['id'] == (pl.get('pl_product_id') or False) and 'selected' or False">
                                            <t t-esc="product['name']"/>
                                          </option>
                                        </t>
                                      </select>
                                    </td>

                                    <td class="d-none d-sm-table-cell">
                                      <span class="qty-view">
                                        <t t-esc="pl.get('pl_qty') if pl.get('pl_qty') is not None else '-'"/>
                                      </span>
                                      <input type="number" min="0" step="1" class="qty-input form-control form-control-sm d-none"
                                             t-att-value="pl.get('pl_qty') if pl.get('pl_qty') is not None else ''"/>
                                    </td>

                                    <td class="d-none d-sm-table-cell">
                                      <span class="depth-view">
                                        <t t-esc="pl.get('pl_depth') if pl.get('pl_depth') is not None else '-'"/>
                                      </span>
                                      <input type="number" min="0" step="0.01" class="depth-input form-control form-control-sm d-none"
                                             t-att-value="pl.get('pl_depth') if pl.get('pl_depth') is not None else ''"/>
                                    </td>

                                    <td>
                                      <button type="button" class="btn btn-sm btn-outline-primary edit-row">Edit</button>
                                      <button type="button" class="btn btn-sm btn-success save-row d-none">Save</button>
                                      <button type="button" class="btn btn-sm btn-secondary cancel-row d-none">Cancel</button>
                                    </td>
                                  </tr>
                                </t>

                              </t>
                            </t>
                            <t t-else="">
                              <tr class="planningline-row" data-editing="0" t-att-data-task-id="task['id']">
                                <td colspan="7">
                                  <table>
                                    <tr><td><span class="text-muted">No.</span></td><td>:</td><td><span class="fw-bold ms-1" t-esc="task['task_no']"/></td></tr>
                                    <tr><td><span class="text-muted">Prj</span></td><td>:</td><td><span class="ms-1" t-esc="task['job_no']"/></td></tr>
                                    <tr><td><span class="text-muted">Desc</span></td><td>:</td><td><span class="ms-1" t-esc="task['task_desc']"/></td></tr>
                                    <tr><td><span class="text-muted">Date</span></td><td>:</td><td><span class="ms-1"><t t-esc="task.get('earliest_start') and task.get('earliest_start').strftime('%Y-%m-%d') or '-'"/></span></td></tr>
                                  </table>
                                </td>
                              </tr>
                            </t>
                          </t>
                        </t>
                        <t t-if="not tasks">
                          <tr>
                            <td colspan="7" class="text-center text-muted">No tasks found.</td>
                          </tr>
                        </t>
                      </tbody>
                    </table>
                  </div>

                  <!-- MOBILE CARD LIST (visible on small screens) -->
                  <div class="d-block d-md-none">
                    <t t-if="tasks">
                      <t t-foreach="tasks" t-as="task">
                        <t t-if="task['planninglines']">
                          <t t-foreach="task['planninglines']" t-as="pl">
                            <div class="mobile-planning-card mb-3 p-3 border rounded bg-white" t-att-data-task-id="task['id']" t-att-data-pl-id="pl['id']">
                              <div class="d-flex justify-content-between align-items-start">
                                <div class="me-2" style="flex:1 1 auto; min-width:0;">
                                  <div class="fw-bold text-truncate"><t t-esc="task['task_no']"/> - <t t-esc="task.get('earliest_start') and task.get('earliest_start').strftime('%Y-%m-%d') or ' '"/></div>
                                  <div class="text-muted small text-truncate">
                                    <span>Prj: </span><t t-esc="task['job_no']"/>
                                  </div>
                                  <div class="small mt-1 text-truncate"><t t-esc="task['task_desc']"/></div>
                                </div>
                                <div class="text-end ms-2" style="flex:0 0 auto;">
                                  <div class="d-flex flex-column align-items-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary edit-row mb-1">Edit</button>
                                    <button type="button" class="btn btn-sm btn-success save-row d-none mb-1">Save</button>
                                    <button type="button" class="btn btn-sm btn-secondary cancel-row d-none">Cancel</button>
                                  </div>
                                </div>
                              </div>

                              <hr class="my-2"/>

                              <!-- Description for mobile (read-only) -->
                              <div class="mb-2">
                                <span class="pl-desc-view d-block small text-muted">
                                  <t t-esc="pl.get('pl_desc') or ''"/>
                                </span>
                              </div>

                              <!-- Hidden id and view elements to match desktop DOM expectations -->
                              <span class="data_planningline_id d-none"><t t-esc="pl['id']"/></span>

                              <div class="mb-1">
                                <div class="small text-muted"><strong>Start:</strong>
                                  <div>
                                    <span class="start-datetime-view"
                                          t-att-data-start-date="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%Y-%m-%d') or ''"
                                          t-att-data-start-datetime="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%Y-%m-%dT%H:%M:%S') or ''">
                                      <t t-esc="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%H:%M') or '-'"/>
                                    </span>
                                    <input type="time" class="start-datetime-input form-control form-control-sm d-none mt-1"
                                           t-att-value="pl['pl_start_datetime'] and pl['pl_start_datetime'].strftime('%H:%M') or ''"/>
                                  </div>
                                </div>
                              </div>

                              <div class="mb-1">
                                <div class="small text-muted"><strong>End:</strong>
                                  <div>
                                    <span class="end-datetime-view"
                                          t-att-data-end-date="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%Y-%m-%d') or ''"
                                          t-att-data-end-datetime="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%Y-%m-%dT%H:%M:%S') or ''">
                                      <t t-esc="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%H:%M') or '-'"/>
                                    </span>
                                    <input type="time" class="end-datetime-input form-control form-control-sm d-none mt-1"
                                           t-att-value="pl['pl_end_datetime'] and pl['pl_end_datetime'].strftime('%H:%M') or ''"/>
                                  </div>
                                </div>
                              </div>

                              <div>
                                <div class="small text-muted"><strong>Item:</strong>
                                  <div>
                                    <span class="product-view">
                                      <t t-esc="dict((r['id'], r['name']) for r in products).get(pl.get('pl_product_id'), '-')"/>
                                    </span>
                                    <select class="product-select form-select form-select-sm d-none mt-1">
                                      <option value=""> - </option>
                                      <t t-foreach="products" t-as="product">
                                        <option t-att-value="product['id']"
                                                t-att-selected="product['id'] == (pl.get('pl_product_id') or False) and 'selected' or False">
                                          <t t-esc="product['name']"/>
                                        </option>
                                      </t>
                                    </select>
                                  </div>
                                </div>
                              </div>

                              <div class="small text-muted"><strong>Qty:</strong>
                                <span class="qty-view ms-1"><t t-esc="pl.get('pl_qty') if pl.get('pl_qty') is not None else '-'"/></span>
                                <input type="number" min="0" step="1" class="qty-input form-control form-control-sm d-none mt-1" t-att-value="pl.get('pl_qty') if pl.get('pl_qty') is not None else ''"/>
                              </div>

                              <div class="small text-muted mt-1"><strong>Depth:</strong>
                                <span class="depth-view ms-1"><t t-esc="pl.get('pl_depth') if pl.get('pl_depth') is not None else '-'"/></span>
                                <input type="number" min="0" step="0.01" class="depth-input form-control form-control-sm d-none mt-1" t-att-value="pl.get('pl_depth') if pl.get('pl_depth') is not None else ''"/>
                              </div>

                            </div>
                          </t>
                        </t>
                        <t t-if="not tasks">
                          <div class="text-center text-muted">No tasks found.</div>
                        </t>
                      </t>
                    </t>
                  </div>

                </div> <!-- card-body -->
              </div> <!-- card -->
            </div> <!-- col -->
          </div> <!-- row -->

        </div> <!-- container -->
      </div> <!-- task_wrap -->
    </t>
  </template>
</odoo>